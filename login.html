<!DOCTYPE html>
<html lang="ur-pk" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SINDH PRICE CONTROL - LOGIN</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .login-card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; border-top: 8px solid #1a5276; }
        img { width: 80px; margin-bottom: 20px; }
        h2 { color: #1a5276; margin-bottom: 25px; }
        input { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 15px; border: none; border-radius: 10px; background: #27ae60; color: white; font-weight: bold; font-size: 18px; cursor: pointer; transition: 0.3s; }
        button:hover { background: #219150; }
        .hidden { display: none; }
        #statusMsg { font-size: 14px; margin-top: 15px; color: #e67e22; }
    </style>
</head>
<body>

<div class="login-card">
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/be/Emblem_of_Sindh.svg/1200px-Emblem_of_Sindh.svg.png">
    <h2>آفیسر لاگ ان</h2>

    <div id="emailSection">
        <input type="email" id="userEmail" placeholder="ای میل درج کریں">
        <button onclick="sendOTP()">او ٹی پی حاصل کریں</button>
    </div>

    <div id="otpSection" class="hidden">
        <p>آپ کی ای میل پر کوڈ بھیج دیا گیا ہے۔</p>
        <input type="number" id="otpInput" placeholder="6 ہندسوں کا کوڈ">
        <button onclick="verifyOTP()">کوڈ کی تصدیق کریں</button>
    </div>

    <div id="passwordSection" class="hidden">
        <input type="password" id="userPass" placeholder="پاس ورڈ درج کریں">
        <button onclick="finalLogin()">لاگ ان کریں</button>
    </div>

    <div id="statusMsg"></div>
</div>

<script>
    // Aapka active Script URL
    const scriptURL = "https://script.google.com/macros/s/AKfycbwUkNKtlw09iCloOAul_QEv0UDcpauWowCN2JIc0ZiEkhi4fYKxTW_o5AzTES-CHc35Ag/exec";
    
    let generatedOTP = "";

    async function sendOTP() {
        const email = document.getElementById('userEmail').value;
        if(!email) { alert("Email zaroori hai"); return; }
        
        const status = document.getElementById('statusMsg');
        status.innerText = "OTP bheja ja raha hai... Intezar karen.";
        
        generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();

        // Fix: fetch with mode 'no-cors' for Google Apps Script
        const url = `${scriptURL}?type=sendOTP&email=${encodeURIComponent(email)}&otp=${generatedOTP}`;
        
        try {
            await fetch(url, { mode: 'no-cors' });
            // 'no-cors' mein response read nahi hota, par request chali jati hai
            document.getElementById('emailSection').classList.add('hidden');
            document.getElementById('otpSection').classList.remove('hidden');
            status.innerText = "OTP bhej diya gaya! Apna Spam folder bhi check karen.";
        } catch (e) {
            status.innerText = "Error: Connection ka masla hai.";
            console.error(e);
        }
    }

    function verifyOTP() {
        const input = document.getElementById('otpInput').value;
        if(input === generatedOTP) {
            document.getElementById('otpSection').classList.add('hidden');
            document.getElementById('passwordSection').classList.remove('hidden');
            document.getElementById('statusMsg').innerText = "Tasdeeq mukammal!";
        } else {
            alert("Ghalat OTP! Dobara koshish karen.");
        }
    }

    async function finalLogin() {
        const email = document.getElementById('userEmail').value;
        const pass = document.getElementById('userPass').value;
        const status = document.getElementById('statusMsg');
        status.innerText = "Checking password...";

        try {
            // Login ke liye humein data chahiye, isliye isay normal fetch karenge
            const response = await fetch(`${scriptURL}?type=login&email=${email}&pass=${pass}`);
            const result = await response.json();

            if (result.status === "success") {
                localStorage.setItem("userRole", result.role);
                localStorage.setItem("userMarket", result.market);
                window.location.href = "officer-dashboard.html";
            } else {
                status.innerText = "Ghalat password!";
            }
        } catch (e) {
            status.innerText = "Login server error!";
        }
    }
</script>

</body>
</html>
