<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مارکیٹ حاضری - Field Visit</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #1b5e20; --gold: #ffd700; --dark: #212121; }
        body { font-family: 'Poppins', sans-serif; background: #f4f7f4; margin: 0; padding-bottom: 50px; }
        
        .header { background: var(--primary); color: white; text-align: center; padding: 20px; border-bottom: 5px solid var(--gold); }
        .header h1 { font-family: 'Noto Nastaliq Urdu', serif; font-size: 18px; margin: 0; }

        .visit-container { padding: 20px; }
        
        /* GPS Box */
        .location-card { background: white; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid #ddd; margin-bottom: 20px; }
        .location-card i { font-size: 40px; color: #d32f2f; margin-bottom: 10px; }
        #coords { font-weight: bold; color: #333; font-size: 14px; margin-top: 10px; }

        /* Camera Box */
        .camera-card { background: var(--dark); border-radius: 15px; padding: 20px; text-align: center; color: white; margin-bottom: 20px; position: relative; overflow: hidden; }
        #video { width: 100%; border-radius: 10px; background: #333; display: none; }
        #canvas { width: 100%; border-radius: 10px; display: none; border: 2px solid var(--gold); }
        
        .action-btn { background: var(--gold); color: var(--dark); width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .submit-visit { background: var(--primary); color: white; margin-top: 20px; }
        
        .status-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 12px; margin-top: 10px; }
        .success { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
    </style>
</head>
<body>

<div class="header">
    <h1>فیلڈ مارکیٹ حاضری (Visit Log)</h1>
    <p style="font-size: 11px;">OFFICIAL FIELD MONITORING SYSTEM</p>
</div>

<div class="visit-container">
    <a href="officer-dashboard.html" style="text-decoration:none; color:var(--primary); font-weight:bold;"><i class="fas fa-arrow-right"></i> ڈیش بورڈ پر واپس جائیں</a>

    <div class="location-card">
        <i class="fas fa-map-marker-alt"></i>
        <div style="font-family:'Noto Nastaliq Urdu'; font-size:16px;">موجودہ لوکیشن (Live GPS)</div>
        <div id="coords">لوکیشن ٹریک کی جا رہی ہے...</div>
        <div id="locStatus" class="status-badge">Waiting for GPS...</div>
    </div>

    <div class="camera-card">
        <div id="cameraPlaceholder">
            <i class="fas fa-user-shield fa-3x" style="color:var(--gold);"></i>
            <p style="font-family:'Noto Nastaliq Urdu';">اپنی سیلفی مارکیٹ کے ساتھ لیں</p>
        </div>
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        
        <button id="startCam" class="action-btn" onclick="initCamera()"><i class="fas fa-camera"></i> کیمرہ کھولیں</button>
        <button id="snap" class="action-btn" style="display:none;" onclick="takeSnapshot()"><i class="fas fa-circle"></i> تصویر کھینچیں</button>
    </div>

    <div style="text-align:right; margin-bottom:10px;">
        <label style="font-family:'Noto Nastaliq Urdu'; font-weight:bold;">مارکیٹ کا نام:</label>
        <input type="text" id="mktName" placeholder="مثلاً: سبزی منڈی، صدر مارکیٹ" style="width:100%; padding:12px; border-radius:10px; border:1px solid #ccc; margin-top:5px;">
    </div>

    <button class="action-btn submit-visit" onclick="submitVisit()">
        <i class="fas fa-cloud-upload-alt"></i> حاضری اپ لوڈ کریں (Submit Visit)
    </button>
</div>

<script>
    // 1. Live GPS Tracking
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        }
    }

    function showPosition(position) {
        document.getElementById("coords").innerText = `Lat: ${position.coords.latitude.toFixed(5)}, Long: ${position.coords.longitude.toFixed(5)}`;
        document.getElementById("locStatus").innerText = "Verified: Location Locked";
        document.getElementById("locStatus").className = "status-badge success";
    }

    function showError(error) {
        document.getElementById("coords").innerText = "لوکیشن نہیں مل سکی! براہ کرم GPS آن کریں۔";
    }

    // 2. Camera Functions
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const startBtn = document.getElementById('startCam');
    const snapBtn = document.getElementById('snap');

    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            video.srcObject = stream;
            video.style.display = "block";
            document.getElementById('cameraPlaceholder').style.display = "none";
            startBtn.style.display = "none";
            snapBtn.style.display = "block";
        } catch (err) {
            alert("کیمرہ تک رسائی نہیں ہو سکی!");
        }
    }

    function takeSnapshot() {
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        video.style.display = "none";
        canvas.style.display = "block";
        snapBtn.innerText = "دوبارہ تصویر لیں";
        snapBtn.onclick = () => location.reload();
    }

    function submitVisit() {
        const mkt = document.getElementById('mktName').value;
        if(!mkt) return alert("مارکیٹ کا نام درج کریں!");
        
        alert("آپ کی مارکیٹ حاضری، لوکیشن اور تصویر کے ساتھ محفوظ کر لی گئی ہے!");
        window.location.href = "officer-dashboard.html";
    }

    // Initialize GPS on load
    getLocation();
</script>

</body>
</html>
